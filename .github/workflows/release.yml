name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: Linux
            preset: Linux
            artifact: FantasiaGamejam2025-Linux.x86_64
          - name: macOS
            preset: macOS
            artifact: FantasiaGamejam2025-macOS.zip
          - name: Windows
            preset: Windows
            artifact: FantasiaGamejam2025-Windows.exe
    container:
      image: barichello/godot-ci:4.5.1
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up export templates
        run: |
          GODOT_VERSION="4.5.1"
          mkdir -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Create exports directory
        run: mkdir -p exports

      - name: Export for ${{ matrix.platform.name }}
        run: godot --headless --path . --export-release "${{ matrix.platform.preset }}" "exports/${{ matrix.platform.artifact }}"

      - name: Upload ${{ matrix.platform.name }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.artifact }}
          path: exports/${{ matrix.platform.artifact }}
          retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: |
            Release ${{ github.event.inputs.version }}
            
            ## Downloads
            - **Linux**: `FantasiaGamejam2025-Linux.x86_64`
            - **macOS**: `FantasiaGamejam2025-macOS.zip`
            - **Windows**: `FantasiaGamejam2025-Windows.exe`
          files: |
            release-artifacts/FantasiaGamejam2025-Linux.x86_64/FantasiaGamejam2025-Linux.x86_64
            release-artifacts/FantasiaGamejam2025-macOS.zip/FantasiaGamejam2025-macOS.zip
            release-artifacts/FantasiaGamejam2025-Windows.exe/FantasiaGamejam2025-Windows.exe
          draft: false
          prerelease: false

      - name: Publish Windows build to itch.io
        uses: yeslayla/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          CHANNEL: windows
          ITCH_GAME: une-journee-a-la-plage
          ITCH_USER: tlenclos
          PACKAGE: release-artifacts/FantasiaGamejam2025-Windows.exe

      - name: Publish Linux build to itch.io
        uses: yeslayla/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          CHANNEL: linux
          ITCH_GAME: une-journee-a-la-plage
          ITCH_USER: tlenclos
          PACKAGE: release-artifacts/FantasiaGamejam2025-Linux.x86_64

      - name: Publish macOS build to itch.io
        uses: yeslayla/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          CHANNEL: mac
          ITCH_GAME: une-journee-a-la-plage
          ITCH_USER: tlenclos
          PACKAGE: release-artifacts/FantasiaGamejam2025-macOS.zip

